<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sikkim — Monasteries with Photo Galleries + Chatbot POI Search + Disaster Markers</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg1:#03061a; --panel:rgba(3,6,23,0.72); --muted:#9fb0c8; --text:#e6eef8;
      --sikkim-yellow:#fff200; --shadow:0 10px 30px rgba(2,6,23,0.6);
      --modal-bg: rgba(1,4,15,0.85);
    }
    *{box-sizing:border-box}
    body,html{height:100%;margin:0;font-family:Nunito,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1) 0%, #071227 60%);color:var(--text)}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;height:100vh}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));padding:14px;border-radius:12px;box-shadow:var(--shadow);color:var(--muted)}
.logo{
      width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent-yellow),#fff);
      display:flex;align-items:center;justify-content:center; position:relative; overflow:hidden;
      box-shadow:0 6px 18px rgba(6,12,40,0.08);
    }
    .logo img{width:56px;height:56px;object-fit:cover;border-radius:10px;display:block}

    h1{margin:0;color:var(--text);font-size:16px}
    label{font-size:13px;color:var(--muted)}
    input[type="search"], select, input[type="range"]{background:transparent;color:inherit;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.04);width:100%}
    .row{display:flex;gap:8px;align-items:center}
    .small{padding:6px 8px;border-radius:8px;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    #map{height:100%;border-radius:12px;box-shadow:var(--shadow)}
    .info{position:absolute;left:28px;top:28px;z-index:1000;background:var(--panel);padding:10px;border-radius:10px;color:var(--text);border:1px solid rgba(255,255,255,0.03);display:flex;gap:10px;align-items:center;max-width:440px}
    .info img{width:76px;height:64px;object-fit:cover;border-radius:8px;cursor:pointer}
    .legend-item{display:flex;gap:8px;align-items:center;font-size:13px}
    .swatch{width:14px;height:12px;border-radius:3px;border:1px solid rgba(0,0,0,0.18)}
    /* Leaflet / popup gallery */
    .leaflet-popup-content-wrapper{border-radius:8px;background:linear-gradient(180deg,#06102a,#071227);color:var(--text);padding:10px;border:1px solid rgba(255,255,255,0.03)}
    .popup-gallery{display:flex;gap:6px;flex-wrap:nowrap;overflow:auto;padding-top:6px}
    .popup-gallery img{height:72px;border-radius:6px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.35);border:2px solid rgba(255,255,255,0.04)}
    /* Modal (lightbox) */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--modal-bg);z-index:14000;padding:24px}
    .modal.show{display:flex}
    .modal .frame{max-width:1100px;width:100%;max-height:90vh;display:flex;flex-direction:column;align-items:center;gap:12px}
    .modal img{max-width:100%;max-height:72vh;border-radius:8px;display:block}
    .modal .caption{color:var(--text);font-size:14px;text-align:center;max-width:100%;word-break:break-word}
    .modal .controls{display:flex;gap:12px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.12);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
    .modal .close{position:absolute;right:24px;top:18px;background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer}

    /* Chatbot UI */
    .chatbot{position:fixed;right:18px;bottom:18px;width:320px;max-width:calc(100% - 36px);z-index:20000;border-radius:12px;overflow:hidden;box-shadow:0 12px 40px rgba(2,6,23,0.6);background:linear-gradient(180deg,rgba(6,12,30,0.9),rgba(2,6,23,0.95));border:1px solid rgba(255,255,255,0.04)}
    .chatbot .header{display:flex;align-items:center;gap:8px;padding:10px}
    .chatbot .header .title{font-weight:700;color:var(--sikkim-yellow)}
    .chatbot .messages{height:240px;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;border-top:1px solid rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.02)}
    .chatbot .msg{Padding:8px 10px;border-radius:10px;max-width:86%;font-size:13px}
    .chatbot .msg.user{align-self:flex-end;background:linear-gradient(90deg,#07119e,#0b5cd1);color:#fff}
    .chatbot .msg.bot{align-self:flex-start;background:rgba(255,255,255,0.03);color:var(--text)}
    .chatbot .input{display:flex;gap:8px;padding:10px}
    .chatbot input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .chatbot .hint{padding:8px;font-size:12px;color:var(--muted)}

    /* Disaster legend (panel) */
    .disaster-legend{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .risk-swatch{display:inline-block;width:14px;height:14px;border-radius:50%;margin-right:8px;vertical-align:middle}

    @media (max-width:520px){ .popup-gallery img{height:56px} .info{max-width:320px} .chatbot{width:92%;right:4%;left:4%} }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="panel" aria-label="Controls">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <div class="logo" aria-hidden="true">
        <img src="https://res.cloudinary.com/dlychx4cg/image/upload/v1757702367/logo_z1lzlb.jpg" alt="Discover Sikkim logo">
      </div>
        <div>
          <h1>Sikkim GeoJSON</h1>
          <div style="font-size:12px;color:var(--muted)">Monasteries with galleries & preview</div>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Search place (Sikkim only)</label>
        <div class="row" style="margin-top:8px"><input id="searchInput" type="search" placeholder="e.g. Gangtok"><button id="searchBtn" class="small">Search</button></div>
        <div id="searchResults" style="display:none;max-height:180px;overflow:auto;border-radius:8px;margin-top:8px"></div>
      </div>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <div class="row"><label style="flex:1">Base map</label><select id="basemapSelect"><option value="osm">OpenStreetMap</option><option value="sat">Satellite</option><option value="gray">Grayscale</option></select></div>
        <div class="row"><label style="flex:1">GeoJSON opacity</label><input id="opacity" type="range" min="0" max="1" step="0.05" value="0.5"></div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <label><input id="colorToggle" type="checkbox" checked> Show district colors</label>
          <label><input id="borderToggle" type="checkbox" checked> Show borders (dark & wide)</label>
          <label><input id="roadsToggle" type="checkbox"> Show roads (OSM)</label>
          <div class="row"><label style="flex:1">Road filter</label><select id="roadsFilterSelect"><option value="major">Major roads</option><option value="national">National Highways (NH)</option></select></div>
          <label><input id="locationsToggle" type="checkbox"> Show important locations (monasteries)</label>
          <label><input id="citiesToggle" type="checkbox"> Show cities</label>
          <label><input id="disasterToggle" type="checkbox"> Show disaster-prone sites</label>
        </div>

        <div class="row"><button id="zoomToAll" class="small">Zoom to Sikkim</button><button id="streetView" class="small">Street View</button></div>

        <div><strong style="color:var(--text)">Districts</strong><div id="legendItems" style="margin-top:8px"></div></div>

        <div style="margin-top:10px"><strong style="color:var(--text)">Disaster legend</strong>
          <div class="disaster-legend" id="disasterLegend"></div>
        </div>
      </div>
    </aside>

    <main style="position:relative">
      <div id="map" role="application" aria-label="Map"></div>
      <div class="info" id="infoCard" aria-live="polite">
        <img id="infoImg" src="https://res.cloudinary.com/dbrvducfo/image/upload/v1757004023/buddha-removebg-preview_razlnq.png" alt="icon">
        <div>
          <div id="infoTitle" style="font-weight:700;color:var(--sikkim-yellow)">Hover a district</div>
          <div id="infoSubtitle" style="color:var(--muted);font-size:13px">Name and properties appear here</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal / lightbox (existing gallery) -->
  <div id="imgModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <button class="close" id="modalClose" aria-label="Close gallery">&times;</button>
    <div class="frame">
      <img id="modalImage" src="" alt="">
      <div class="caption" id="modalCaption"></div>
      <div class="controls">
        <button id="prevBtn" class="btn">◀ Prev</button>
        <button id="nextBtn" class="btn">Next ▶</button>
      </div>
    </div>
  </div>

  <!-- Chatbot UI -->
  <div id="chatbot" class="chatbot" role="dialog" aria-label="Map assistant">
    <div class="header"><div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#07119e,#fff200);display:flex;align-items:center;justify-content:center;font-weight:800;color:#071227">AI</div><div>
      <div class="title">Map Assistant</div>
      <div style="font-size:12px;color:var(--muted)">Try "restaurants near me"</div>
    </div></div>
    <div class="messages" id="chatMessages" aria-live="polite"></div>
    <div class="hint" style="padding:8px">Quick: <button class="small" id="hintRest">Restaurants near me</button> <button class="small" id="hintCafe">Cafes near Gangtok</button></div>
    <div class="input"><input id="chatInput" type="text" placeholder="Ask: e.g. petrol pump near me" aria-label="Ask map assistant"><button id="chatSend" class="small">Send</button></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /***** DATA PLACEHOLDERS (server templating) *****/
    const DISTRICTS = {{ geojson|safe }}; // FeatureCollection (districts)
    const CITIES = {{ citiesgeojson|safe }} || {type:'FeatureCollection',features:[]};

    /* LOCATIONS: each feature has .properties.images = [url1,url2,url3,...] and .properties.desc */
    const LOCATIONS = {
      "type": "FeatureCollection",
      "features": [
        {
          "type":"Feature",
          "properties":{
            "name":"Rumtek Monastery",
            "type":"monastery",
            "images":[
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697906/images_7_i301cf.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697952/Blog_20241231-1706054417-1735621009_jtyild.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757698005/c9c97b5f09b4294d3f01100d180d98aa_1000x1000_bqtspl.jpg"
            ],
            "desc":"Rumtek — seat of the Karmapa lineage."
          },
          "geometry":{"type":"Point","coordinates":[88.536370,27.305827]}
        },
        {
          "type":"Feature",
          "properties":{
            "name":"Enchey Monastery (Gangtok)",
            "type":"monastery",
            "images":[
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697721/images_4_vcvf6i.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697781/images_5_e6pybu.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697827/images_6_rnpzz6.jpg"
            ],
            "desc":"Enchey — a 200+-year-old monastery in Gangtok."
          },
          "geometry":{"type":"Point","coordinates":[88.619194,27.335863]}
        },
        {
          "type":"Feature",
          "properties":{
            "name":"Pemayangtse Monastery (Pelling)",
            "type":"monastery",
            "images":[
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757685530/caf66d7d-26b2-43e4-a4b5-58d9ac8c6d90.png",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757685611/b43bd757-6d4b-40cf-aaa4-57a360009a06.png",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757685672/pemayangtse-monastery-03.jpg_braohc.webp"
            ],
            "desc":"Pemayangtse — one of Sikkim's oldest monasteries."
          },
          "geometry":{"type":"Point","coordinates":[88.252040,27.304530]}
        },
        {
          "type":"Feature",
          "properties":{
            "name":"Tashiding Monastery",
            "type":"monastery",
            "images":[
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757685750/Tashiding-Monastery-Sightseeing_uydhje.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757685821/20140371823_49e88604f9_b_upmc6j.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757685884/tashiding-monastery-pelling-sikkim-2-attr-hero_ihbgk9.jpg"
            ],
            "desc":"Tashiding — sacred monastery on the Rathong river."
          },
          "geometry":{"type":"Point","coordinates":[88.297680,27.308690]}
        },
        {
          "type":"Feature",
          "properties":{
            "name":"Phodong Monastery",
            "type":"monastery",
            "images":[
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757686007/images_lkofob.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757686045/darj_i0007d3_qsf7vo.webp",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757686113/images_1_l71mxb.jpg"
            ],
            "desc":"Phodong — known for festivals and views."
          },
          "geometry":{"type":"Point","coordinates":[88.582944,27.416786]}
        },
        {
          "type":"Feature",
          "properties":{
            "name":"Ralang (Ralong) Monastery",
            "type":"monastery",
            "images":[
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697544/90830ab2-8705-4335-ba56-1f3aa8d5a53c_y2phwp.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697593/images_2_d89zma.jpg",
              "https://res.cloudinary.com/dlychx4cg/image/upload/v1757697631/images_3_inniso.jpg"
            ],
            "desc":"Ralang — scenic monastery near Namchi."
          },
          "geometry":{"type":"Point","coordinates":[88.334780,27.328560]}
        }
      ]
    };

    /***** MAP & TILES *****/
    const map = L.map('map', { zoomControl:false });
    L.control.scale({position:'bottomleft'}).addTo(map);
    L.control.zoom({position:'bottomright'}).addTo(map);

    const tiles = {
      osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap contributors'}),
      sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
      gray: L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png',{maxZoom:18})
    };
    tiles.osm.addTo(map);

    // panes for proper z-ordering
    map.createPane('roadsPane'); map.getPane('roadsPane').style.zIndex = 620;
    map.createPane('locationsPane'); map.getPane('locationsPane').style.zIndex = 660; // above roads
    map.createPane('citiesPane'); map.getPane('citiesPane').style.zIndex = 680;       // above locations
    map.createPane('disasterPane'); map.getPane('disasterPane').style.zIndex = 700;   // topmost for disaster markers

    /***** STYLES & HELPERS *****/
    const districtColors = {
      'East District':'#fff200','North  District':'#07119e','South District':'#ff1b00','West District':'#2ea043'
    };
    const baseBorder = { color:getComputedStyle(document.documentElement).getPropertyValue('--border-dark') || '#000814', weight:4 };
    function getDistrictName(p){ return p && (p.Dist_Name || p.DIST_NAME || p.Dist || p.name) || 'District'; }
    function getColor(name){ return districtColors[name] || '#94a3b8'; }
    const geoStyle = (feature)=>({
      color: baseBorder.color,
      weight: baseBorder.weight,
      fillColor: getColor(getDistrictName(feature.properties)),
      fillOpacity: parseFloat(document.getElementById('opacity').value || 0.5)
    });

    /***** INFO CARD HELPERS *****/
    const infoImg = document.getElementById('infoImg');
    const infoTitle = document.getElementById('infoTitle');
    const infoSubtitle = document.getElementById('infoSubtitle');

    function setInfoCard({title, subtitle, img, images} = {}){
      if(!title){
        infoImg.src = 'https://res.cloudinary.com/dbrvducfo/image/upload/v1757004023/buddha-removebg-preview_razlnq.png';
        infoImg.alt = 'icon';
        infoTitle.textContent = 'Hover a district';
        infoSubtitle.textContent = 'Name and properties appear here';
        infoImg.onclick = null;
        return;
      }
      infoTitle.textContent = title;
      infoSubtitle.textContent = subtitle || '';
      if(images && images.length) { infoImg.src = images[0]; infoImg.alt = title; infoImg.onclick = ()=> openModal(images, 0); }
      else if(img){ infoImg.src = img; infoImg.alt = title; infoImg.onclick = ()=> openModal([img], 0); }
    }

    /***** GEOJSON LAYER (districts) *****/
    const svgRenderer = L.svg();
    const districtsLayer = L.geoJSON(DISTRICTS, {
      renderer: svgRenderer,
      style: geoStyle,
      onEachFeature(feature, layer){
        const p = feature.properties || {};
        layer.bindTooltip(`<strong style="color:#fff">${p.Dist_Name||'District'}</strong><div style="font-size:12px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">${p.State_Name||''}</div>`, {className:'nice-tooltip'});
        layer.on({
          mouseover(e){
            const showColors = document.getElementById('colorToggle').checked;
            const showBorders = document.getElementById('borderToggle').checked;
            const name = getDistrictName(e.target.feature.properties);
            e.target.setStyle({
              fillOpacity: showColors ? 0.75 : 0,
              fillColor: getColor(name),
              color: showBorders ? baseBorder.color : 'transparent',
              weight: showBorders ? baseBorder.weight + 2 : 0
            });
            if(e.target.bringToFront) e.target.bringToFront();
            setInfoCard({ title: getDistrictName(e.target.feature.properties), subtitle: e.target.feature.properties.State_Name || '' });
          },
          mouseout(e){ updateLayerStyle(e.target); setInfoCard(); },
          click(e){ map.flyToBounds(e.target.getBounds(), {padding:[20,20], duration:0.8}); }
        });
      }
    }).addTo(map);

    function updateLayerStyle(layer){
      if(!layer || !layer.feature) return;
      const showColor = document.getElementById('colorToggle').checked;
      const showBorder = document.getElementById('borderToggle').checked;
      const name = getDistrictName(layer.feature.properties);
      layer.setStyle({
        fillColor: showColor ? getColor(name) : 'transparent',
        fillOpacity: showColor ? parseFloat(document.getElementById('opacity').value) : 0,
        color: showBorder ? baseBorder.color : 'transparent',
        weight: showBorder ? baseBorder.weight : 0
      });
    }
    function updateAll(){ districtsLayer.eachLayer(updateLayerStyle); }

    /***** LEGEND *****/
    const legendEl = document.getElementById('legendItems');
    Object.entries(districtColors).forEach(([k,v])=>{
      const d = document.createElement('div'); d.className='legend-item';
      d.innerHTML = `<div class="swatch" style="background:${v}"></div><div style="color:var(--text)">${k}</div>`;
      legendEl.appendChild(d);
    });

    /***** BOUNDS, MIN/MAX ZOOM *****/
    const bounds = districtsLayer.getBounds();
    if(bounds.isValid()){ map.fitBounds(bounds, {padding:[20,20]}); map.setMaxBounds(bounds.pad(0.15)); map.setMinZoom(map.getBoundsZoom(bounds)); }
    else map.setView([27.5,88.5],8);

    /***** BASemap switcher *****/
    document.getElementById('basemapSelect').addEventListener('change', (e)=>{
      Object.values(tiles).forEach(t=>{ if(map.hasLayer(t)) map.removeLayer(t); });
      tiles[e.target.value].addTo(map);
      if(window.roadsLayer && map.hasLayer(window.roadsLayer)) window.roadsLayer.bringToFront();
      if(window.locationsLayer && map.hasLayer(window.locationsLayer)) window.locationsLayer.bringToFront();
      if(window.citiesLayer && map.hasLayer(window.citiesLayer)) window.citiesLayer.bringToFront();
      if(window.disasterLayer && map.hasLayer(window.disasterLayer)) window.disasterLayer.bringToFront();
      if(map.hasLayer(districtsLayer)) districtsLayer.bringToFront();
    });

    /***** SEARCH (Nominatim bounded to Sikkim) *****/
    const SIKKIM_BBOX = [87.8,26.8,88.95,28.2]; // minLon,minLat,maxLon,maxLat
    async function geocode(q){
      if(!q) return [];
      const vb = `${SIKKIM_BBOX[0]},${SIKKIM_BBOX[1]},${SIKKIM_BBOX[2]},${SIKKIM_BBOX[3]}`;
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&viewbox=${vb}&bounded=1&countrycodes=in&q=${encodeURIComponent(q)}`;
      try{
        const res = await fetch(url, { headers:{ 'Accept':'application/json','User-Agent':'SikkimGeo/1.0 (you@example.com)'}});
        if(!res.ok) return [];
        return await res.json();
      }catch(e){ console.warn(e); return []; }
    }
    const searchResults = document.getElementById('searchResults'), searchLayer = L.layerGroup().addTo(map);
    function showResults(list){
      searchResults.innerHTML = '';
      const filtered = (list||[]).filter(i => (i.address && i.address.state && i.address.state.toLowerCase().includes('sikkim')) || (i.display_name && i.display_name.toLowerCase().includes('sikkim')));
      if(!filtered.length){ searchResults.innerHTML = `<div style="padding:8px;color:var(--muted)">No results inside Sikkim.</div>`; searchResults.style.display='block'; return; }
      filtered.forEach(item=>{
        const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.03)';
        div.innerHTML = `<strong style="color:var(--text)">${(item.display_name||'')}</strong><br><small style="color:var(--muted)">${item.type}</small>`;
        div.addEventListener('click', ()=>selectResult(item)); searchResults.appendChild(div);
      });
      searchResults.style.display='block';
    }
    async function selectResult(item){
      searchResults.style.display='none'; searchLayer.clearLayers();
      const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
      if(item.boundingbox && item.boundingbox.length===4){
        const b = item.boundingbox.map(Number);
        const bb = L.latLngBounds([Math.min(b[0],b[1]),Math.min(b[2],b[3])],[Math.max(b[0],b[1]),Math.max(b[2],b[3])]);
        if(Math.abs(bb.getNorth() - bb.getSouth()) < 0.0005 && Math.abs(bb.getEast() - bb.getWest()) < 0.0005) map.setView([lat,lon],15);
        else map.flyToBounds(bb,{padding:[20,20],duration:0.8});
      } else map.flyTo([lat,lon],15,{duration:0.8});
      L.marker([lat,lon]).addTo(searchLayer).bindPopup(`<strong>${item.display_name}</strong>`).openPopup();
    }
    document.getElementById('searchBtn').addEventListener('click', async ()=>{
      const q = document.getElementById('searchInput').value.trim(); if(!q) return;
      searchResults.innerHTML = '<div style="padding:8px">Searching…</div>'; searchResults.style.display='block';
      const res = await geocode(q); showResults(res);
    });
    document.getElementById('searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('searchBtn').click(); } });

    /***** CITIES & LOCATIONS (toggle layers) *****/
    function createCities(){
      if(window.citiesLayer) return window.citiesLayer;
      window.citiesLayer = L.geoJSON(CITIES, {
        pane: 'citiesPane',
        pointToLayer(f,latlng){
          const n = (f.properties&&f.properties.name)||'';
          const icon = L.divIcon({ html:`<div style="display:flex;flex-direction:column;align-items:center;font-size:12px"><div style="background:rgba(7,17,158,0.95);color:#fff;padding:4px 6px;border-radius:12px;font-weight:700">${n}</div><div style="width:8px;height:8px;border-radius:50%;background:#f59e0b;margin-top:4px"></div></div>`, className:'', iconSize:[70,36], iconAnchor:[35,36]});
          return L.marker(latlng,{icon, zIndexOffset:1000});
        }
      });
      return window.citiesLayer;
    }

    // createLocations uses divIcon so monastery names are shown as labels and popups show galleries
    function createLocations(){
      if(window.locationsLayer) return window.locationsLayer;
      window.locationsLayer = L.geoJSON(LOCATIONS, {
        pane: 'locationsPane',
        pointToLayer(feature, latlng){
          const name = (feature.properties && feature.properties.name) || '';
          const html = `
            <div style="display:flex;flex-direction:column;align-items:center;pointer-events:auto;font-family:Nunito,system-ui;">
              <div style="background:rgba(255,255,255,0.95);color:#071227;padding:6px 10px;border-radius:14px;font-weight:700;white-space:nowrap;box-shadow:0 8px 20px rgba(2,6,23,0.45)">${name}</div>
              <div style="width:10px;height:10px;border-radius:50%;background:var(--sikkim-yellow);margin-top:6px;border:1px solid rgba(0,0,0,0.18)"></div>
            </div>`;
          const icon = L.divIcon({ html, className:'', iconSize:[140,48], iconAnchor:[70,48] });
          return L.marker(latlng, { icon, zIndexOffset:2000 });
        },
        onEachFeature(feature, layer){
          const p = feature.properties || {};
          const name = p.name || 'Location';
          const desc = p.desc || '';
          const images = Array.isArray(p.images) ? p.images : (p.images ? [p.images] : []);
          // popup: title + thumbnails (thumbnails are same image scaled)
          let thumbsHtml = '<div class="popup-gallery">';
          (images.length ? images : ['https://placehold.co/600x400?text=No+image']).forEach((u,i)=>{
            thumbsHtml += `<img class="popup-thumb" data-index="${i}" src="${u}" alt="${name} photo ${i+1}">`;
          });
          thumbsHtml += '</div>';
          const popupHtml = `<strong>${name}</strong><div style="font-size:13px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">${desc}</div>${thumbsHtml}`;
          layer.bindPopup(popupHtml, {maxWidth:380});

          // when marker clicked: update info card and open the REGULAR gallery modal (not panorama)
          layer.on('click', function(){
            setInfoCard({ title: name, subtitle: desc, images: images });
            // open the normal gallery modal (thumbnails in popup will also open it)
            openModal(images, 0);
          });
        }
      });
      return window.locationsLayer;
    }

    document.getElementById('citiesToggle').addEventListener('change', e=>{
      if(e.target.checked) createCities().addTo(map).bringToFront(); else if(window.citiesLayer) map.removeLayer(window.citiesLayer);
    });
    document.getElementById('locationsToggle').addEventListener('change', e=>{
      if(e.target.checked) createLocations().addTo(map).bringToFront();
      else if(window.locationsLayer) map.removeLayer(window.locationsLayer);
    });

    // Reset infoCard on popup close (unless you'd like to keep last)
    map.on('popupclose', function(){ setInfoCard(); });

    /***** DISASTER-PRONE SITES LAYER *****/
    /* We'll add color-coded circleMarkers with popups describing disaster type & recommended monitoring */
    const DISASTER_SITES = [
      { id: 'rumtek', name: 'Rumtek Monastery (near Gangtok)', coords: [27.305827, 88.536370], risk: 'high', types: ['landslide', 'heavy rain', 'historical earthquake damage'], note: 'Repeated landslides/heavy-rain events; structural vulnerability reported. Monitor Gangtok DDMA and rainfall/landslide alerts.' },
      { id: 'enchey', name: 'Enchey / Inchey (Gangtok)', coords: [27.335863, 88.619194], risk: 'high', types: ['landslide', 'localized damage'], note: 'Localized slope failures reported during heavy rain episodes — monitor local advisories.' },
      { id: 'pemayangtse', name: 'Pemayangtse (Pelling, West Sikkim)', coords: [27.304530, 88.252040], risk: 'medium', types: ['landslide', 'slope failure'], note: 'Historical landslide incidents have affected precincts; West Sikkim slopes prone during heavy rains.' },
      { id: 'tashiding', name: 'Tashiding (Pelling area)', coords: [27.308690, 88.297680], risk: 'medium', types: ['landslide', 'access disruption'], note: 'Statewide Oct 2023 GLOF and subsequent landslides impacted access — treat as medium risk.' },
      { id: 'ralang', name: 'Ralang (near Namchi)', coords: [27.328560, 88.334780], risk: 'medium', types: ['landslide', 'access disruption'], note: 'Medium risk due to regional landslide/flood events affecting nearby valleys.' },
      { id: 'phodong', name: 'Phodong (near Mangan/Gangtok area)', coords: [27.416786, 88.582944], risk: 'medium', types: ['landslide', 'access disruption'], note: 'Treat as medium-risk; monitor road/bridge status after major rains.' },
      // representative North Sikkim area marker (Lachung/Lachen/Chungthang corridor)
      { id: 'north_sikkim', name: 'North Sikkim region (Lachung / Lachen / Chungthang area)', coords: [27.65, 88.62], risk: 'high', types: ['GLOF', 'landslide', 'flood'], note: 'High priority: Oct 2023 GLOF and June 2025 Chaten landslides affected this region. Monitor GLOF/landslide/flood warnings and access advisories.' }
    ];

    const RISK_COLORS = { high: '#ff0033', medium: '#ff8c00', low: '#ffd166' };

    function createDisasterLayer(){
      if(window.disasterLayer) return window.disasterLayer;
      window.disasterLayer = L.layerGroup([], { pane: 'disasterPane' });

      DISASTER_SITES.forEach(site => {
        const marker = L.circleMarker(site.coords, {
          radius: site.risk === 'high' ? 9 : (site.risk === 'medium' ? 7 : 6),
          color: RISK_COLORS[site.risk] || RISK_COLORS.medium,
          fillColor: RISK_COLORS[site.risk] || RISK_COLORS.medium,
          fillOpacity: 0.9,
          weight: 2
        });
        const popupHtml = `<strong style="font-size:14px">${site.name}</strong><div style="font-size:13px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')};margin-top:6px">Risk: <strong>${site.risk.toUpperCase()}</strong></div><div style="margin-top:6px;font-size:13px">Hazards: ${site.types.join(', ')}</div><div style="margin-top:6px;font-size:13px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">${site.note}</div>`;
        marker.bindPopup(popupHtml, { maxWidth:380 });
        marker.on('click', ()=> setInfoCard({ title: site.name, subtitle: site.types.join(', ')}));
        window.disasterLayer.addLayer(marker);
      });

      return window.disasterLayer;
    }

    // populate disaster legend in the panel
    const disasterLegend = document.getElementById('disasterLegend');
    const legendItems = [ ['High risk', RISK_COLORS.high], ['Medium risk', RISK_COLORS.medium], ['Low risk', RISK_COLORS.low] ];
    legendItems.forEach(([label, color])=>{
      const el = document.createElement('div'); el.className='legend-item';
      el.innerHTML = `<span class="risk-swatch" style="background:${color}"></span><span style="color:var(--text)">${label}</span>`;
      disasterLegend.appendChild(el);
    });

    document.getElementById('disasterToggle').addEventListener('change', (e)=>{
      if(e.target.checked) {
        createDisasterLayer().addTo(map).bringToFront();
      } else if(window.disasterLayer) {
        map.removeLayer(window.disasterLayer);
      }
    });

    /***** POPUP THUMB HANDLING & MODAL LIGHTBOX *****/
    const modal = document.getElementById('imgModal');
    const modalImage = document.getElementById('modalImage');
    const modalCaption = document.getElementById('modalCaption');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const modalClose = document.getElementById('modalClose');

    let galleryImages = [];
    let galleryIndex = 0;

    function openModal(images, startIndex = 0){
      if(!Array.isArray(images) || images.length === 0) return;
      galleryImages = images.slice();
      galleryIndex = Math.max(0, Math.min(startIndex || 0, galleryImages.length - 1));
      showModalIndex(galleryIndex);
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      document.addEventListener('keydown', modalKeyHandler);
    }

    function closeModal(){
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
      galleryImages = [];
      galleryIndex = 0;
      document.removeEventListener('keydown', modalKeyHandler);
    }

    function showModalIndex(i){
      if(!galleryImages || galleryImages.length === 0) return;
      galleryIndex = (i + galleryImages.length) % galleryImages.length;
      modalImage.src = galleryImages[galleryIndex];
      modalImage.alt = modalCaption.textContent = (galleryImages[galleryIndex] && `Image ${galleryIndex+1} of ${galleryImages.length}`) || '';
    }

    function modalKeyHandler(e){
      if(e.key === 'Escape') closeModal();
      else if(e.key === 'ArrowLeft') showModalIndex(galleryIndex - 1);
      else if(e.key === 'ArrowRight') showModalIndex(galleryIndex + 1);
    }

    prevBtn.addEventListener('click', ()=> showModalIndex(galleryIndex - 1));
    nextBtn.addEventListener('click', ()=> showModalIndex(galleryIndex + 1));
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (ev)=>{
      if(ev.target === modal) closeModal(); // click outside to close
    });

    // when a popup opens, wire up thumbnail clicks inside the popup DOM (these open the regular modal)
    map.on('popupopen', function(e){
      try{
        const popupEl = e.popup.getElement();
        const sourceFeature = e.popup._source && e.popup._source.feature;
        const images = (sourceFeature && sourceFeature.properties && Array.isArray(sourceFeature.properties.images)) ? sourceFeature.properties.images : [];
        if(!popupEl) return;
        // find thumbnails
        const thumbs = popupEl.querySelectorAll('.popup-thumb');
        thumbs.forEach((imgEl)=>{
          imgEl.style.cursor = 'zoom-in';
          imgEl.onclick = function(){
            const idx = Number(this.getAttribute('data-index')) || 0;
            // open modal with images
            openModal(images.length ? images : [this.src], idx);
          };
        });
      }catch(err){ console.warn(err); }
    });

    /***** ZOOM / STREET VIEW BUTTONS *****/
    document.getElementById('zoomToAll').addEventListener('click', ()=>{ if(bounds.isValid()) map.flyToBounds(bounds,{padding:[20,20],duration:0.9}); });
    document.getElementById('streetView').addEventListener('click', ()=>{ const c = bounds.getCenter(); window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${c.lat},${c.lng}`,'_blank'); });

    /***** OSM ROADS (Overpass) - lightweight logic (unchanged) *****/
    const OVERPASS = ['https://overpass-api.de/api/interpreter','https://overpass.kumi.systems/api/interpreter'];
    function highwayWeight(hw){ if(!hw) return 2; if(/motorway|trunk|primary/.test(hw)) return 6; if(/secondary|tertiary/.test(hw)) return 4; return 2; }
    function styleRoad(f){ const hw = (f.properties && f.properties.highway)||''; const color = /motorway/.test(hw)?'rgba(220,53,69,0.95)':/trunk/.test(hw)?'rgba(255,140,0,0.95)':/primary/.test(hw)?'rgba(255,215,0,0.95)':'rgba(200,200,200,0.95)'; return {color,weight:highwayWeight(hw),opacity:0.95,lineCap:'round'}; }
    async function fetchRoads(mode){
      const s=SIKKIM_BBOX[1], w=SIKKIM_BBOX[0], n=SIKKIM_BBOX[3], e=SIKKIM_BBOX[2];
      const bbox = `${s},${w},${n},${e}`;
      const q = mode==='national' ? `[out:json][timeout:60];(way["highway"]["ref"~"^NH"](${bbox});way["highway"]["name"~"\\bNational Highway\\b",i](${bbox}););out geom;` :
        `[out:json][timeout:60];(way["highway"~"^(motorway|trunk|primary|secondary|tertiary|motorway_link|trunk_link|primary_link|secondary_link)$"](${bbox}););out geom;`;
      for(const ep of OVERPASS){
        try{
          const res = await fetch(ep,{method:'POST',body:q,headers:{'Content-Type':'text/plain'}});
          if(!res.ok) throw new Error(res.status);
          const json = await res.json();
          const ways = (json.elements||[]).filter(el=>el.type==='way'&&el.geometry);
          if(!ways.length) throw new Error('no ways');
          const geo = {type:'FeatureCollection',features:ways.map(w=>({type:'Feature',geometry:{type:'LineString',coordinates:w.geometry.map(g=>[g.lon,g.lat])},properties: Object.assign({}, w.tags||{}, {osmid:w.id})}))};
          if(window.roadsLayer) map.removeLayer(window.roadsLayer);
          window.roadsLayer = L.geoJSON(geo,{pane:'roadsPane',style:styleRoad,onEachFeature(f,l){const name=f.properties.name||''; if(name||f.properties.highway) l.bindPopup(`<strong>${name||'(unnamed)'}</strong><br><small>${f.properties.highway||''}</small>`)} });
          if(document.getElementById('roadsToggle').checked) window.roadsLayer.addTo(map).bringToFront();
          if(window.locationsLayer && map.hasLayer(window.locationsLayer)) window.locationsLayer.bringToFront();
          if(window.citiesLayer && map.hasLayer(window.citiesLayer)) window.citiesLayer.bringToFront();
          return;
        }catch(err){ console.warn('Overpass',err); }
      }
      console.warn('All Overpass endpoints failed');
    }
    document.getElementById('roadsToggle').addEventListener('change', async (e)=>{
      if(e.target.checked) await fetchRoads(document.getElementById('roadsFilterSelect').value);
      else if(window.roadsLayer) map.removeLayer(window.roadsLayer);
    });
    document.getElementById('roadsFilterSelect').addEventListener('change', async ()=>{
      if(document.getElementById('roadsToggle').checked){ if(window.roadsLayer) { map.removeLayer(window.roadsLayer); window.roadsLayer=null; } await fetchRoads(document.getElementById('roadsFilterSelect').value); }
    });

    /***** ACCESSIBILITY SETUP & INITIAL SYNC *****/
    document.getElementById('map').setAttribute('tabindex','0');
    updateAll();

    /**************************************************************************
     * Single random marker that links to your external panorama URL.
     * This replaces the previous embedded panorama: clicking the marker opens
     * http://127.0.0.1:8000/pan in a new tab.
     **************************************************************************/
    function randomInRange(min, max){ return Math.random() * (max - min) + min; }
    function addRandomPanoramaLinkMarker(){
      // bounds fallback to SIKKIM_BBOX if district bounds invalid
      let minLon = SIKKIM_BBOX[0], minLat = SIKKIM_BBOX[1], maxLon = SIKKIM_BBOX[2], maxLat = SIKKIM_BBOX[3];
      if(bounds && bounds.isValid()){
        const b = bounds;
        minLat = b.getSouth(); maxLat = b.getNorth(); minLon = b.getWest(); maxLon = b.getEast();
      }
      const lon = randomInRange(minLon, maxLon);
      const lat = randomInRange(minLat, maxLat);

      // create marker and popup with an explicit hyperlink
      const marker = L.marker([lat, lon], { title: 'Open Panorama (external)' }).addTo(map);
      // Use a safe, explicit link opening in a new tab
      const popupHtml = `<strong>Panorama (external)</strong><div style="margin-top:6px;font-size:13px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">Open the panoramic viewer at:</div><div style="margin-top:8px"><a href="http://127.0.0.1:8000/pan" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8000/pan</a></div>`;
      marker.bindPopup(popupHtml, {maxWidth:380});
      // optional: on click also open the link directly in new tab (uncomment if desired)
      // marker.on('click', ()=> window.open('http://127.0.0.1:8000/pan', '_blank', 'noopener'));
    }

    // add the single random link marker on map load (small timeout to allow fitBounds)
    setTimeout(()=> addRandomPanoramaLinkMarker(), 250);

    /***** initial sync of layers (if toggles were checked) *****/
    if(document.getElementById('locationsToggle').checked) createLocations().addTo(map).bringToFront();
    if(document.getElementById('citiesToggle').checked) createCities().addTo(map).bringToFront();

    /**************************************************************************
     * Chatbot / POI search integration
     * - Recognizes queries such as "restaurants near me", "cafes near Gangtok", "atm near me"
     * - Uses Overpass (recommended) within a radius around user's location or current map center
     * - Falls back to Nominatim when the query is more generic ("pizza in Gangtok")
     **************************************************************************/
    const poiLayer = L.layerGroup().addTo(map);
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const hintRest = document.getElementById('hintRest');
    const hintCafe = document.getElementById('hintCafe');

    function appendChat(sender, text){
      const d = document.createElement('div'); d.className = 'msg ' + (sender==='user'?'user':'bot'); d.textContent = text;
      chatMessages.appendChild(d); chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // simple mapping of user words to OSM keys
    const POI_KEYWORDS = {
      'restaurant':'amenity=restaurant','restaurants':'amenity=restaurant','cafe':'amenity=cafe','cafes':'amenity=cafe',
      'atm':'amenity=atm','bank':'amenity=bank','hospital':'amenity=hospital','pharmacy':'amenity=pharmacy',
      'hotel':'tourism=hotel','guesthouse':'tourism=guest_house','fuel':'amenity=fuel','petrol':'amenity=fuel',
      'supermarket':'shop=supermarket','market':'shop=supermarket','bar':'amenity=bar','pub':'amenity=pub',
      'bakery':'shop=bakery','grocery':'shop=convenience','school':'amenity=school','temple':'amenity=place_of_worship',
      'parking':'amenity=parking','bus stop':'highway=bus_stop','train station':'railway=station'
    };

    function detectTypeAndPlace(q){
      const s = q.toLowerCase();
      // detect exact keyword
      for(const k of Object.keys(POI_KEYWORDS)){
        if(s.includes(k)){
          // check for "near <place>" pattern
          const nearMatch = s.match(/near(?:st|by)?\s+([a-z\s]+)/i) || s.match(/in\s+([a-z\s]+)/i);
          const place = nearMatch ? nearMatch[1].trim().replace(/\.$/,'') : null;
          const useMe = /near me|nearby|close to me/.test(s);
          return {keyword:k, osm: POI_KEYWORDS[k], place, useMe};
        }
      }
      // fallback: try to detect "near me"
      if(/near me|nearby|around me/.test(s)) return {keyword:null, osm:null, place:null, useMe:true};
      return {keyword:null, osm:null, place:null, useMe:false};
    }

    async function runOverpassQuery(queryBody){
      // try endpoints in order
      for(const ep of OVERPASS){
        try{
          const res = await fetch(ep, { method:'POST', body:queryBody, headers:{'Content-Type':'text/plain'} });
          if(!res.ok) throw new Error(res.status);
          const json = await res.json();
          return json;
        }catch(err){ console.warn('Overpass error', err); }
      }
      return null;
    }

    function clearPOIs(){ poiLayer.clearLayers(); }

    async function searchPOIsByType(osmKey, center, radiusMeters=3000){
      // osmKey like 'amenity=restaurant' or 'shop=supermarket'
      const [k,v] = osmKey.split('=');
      const q = `[out:json][timeout:25];(node["${k}"="${v}"](around:${radiusMeters},${center.lat},${center.lng});way["${k}"="${v}"](around:${radiusMeters},${center.lat},${center.lng});relation["${k}"="${v}"](around:${radiusMeters},${center.lat},${center.lng}););out center;`;
      const json = await runOverpassQuery(q);
      if(!json || !json.elements) return [];
      return json.elements.map(el=>{
        const lat = el.lat || (el.center && el.center.lat);
        const lon = el.lon || (el.center && el.center.lon);
        return { id: el.id, lat, lon, tags: el.tags || {}, type: el.type };
      }).filter(x=>x.lat && x.lon);
    }

    function addPOIMarkers(items, center=null){
      clearPOIs();
      if(!items || !items.length) return;
      const bounds = [];
      items.forEach(it=>{
        const title = it.tags && (it.tags.name || it.tags.operator) || '(unnamed)';
        const sub = Object.entries(it.tags||{}).slice(0,4).map(([a,b])=>`${a}:${b}`).join('<br>');
        const m = L.marker([it.lat, it.lon]).addTo(poiLayer).bindPopup(`<strong>${title}</strong><div style="font-size:12px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">${sub}</div>`);
        bounds.push([it.lat, it.lon]);
      });
      if(bounds.length){
        const bb = L.latLngBounds(bounds);
        map.fitBounds(bb.pad(0.2));
      }
    }

    async function handleQuery(raw){
      const q = raw.trim(); if(!q) return;
      appendChat('user', q);
      appendChat('bot', 'Searching...');
      const parsed = detectTypeAndPlace(q);

      // decide center: user location preferred for 'near me'
      let center = null;
      if(parsed.useMe){
        try{
          const pos = await new Promise((resolve, reject)=>{
            if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(resolve, reject, {timeout:8000}); }
            else reject(new Error('no geolocation'));
          });
          center = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        }catch(err){
          // fallback to map center
          center = map.getCenter();
        }
      } else if(parsed.place){
        // geocode place (bounded to sikkim) to get a center
        const res = await geocode(parsed.place);
        if(res && res.length){ center = { lat: parseFloat(res[0].lat), lng: parseFloat(res[0].lon) }; }
        else center = map.getCenter();
      } else {
        center = map.getCenter();
      }

      // perform search
      let results = [];
      if(parsed.osm){
        // type-based overpass search using progressively larger radii until we find results
        let radius = 1500;
        for(let i=0;i<4;i++){
          results = await searchPOIsByType(parsed.osm, center, radius);
          if(results && results.length) break;
          radius *= 2; // expand
        }
      } else {
        // fallback: use Nominatim to search place + amenity keywords
        // do a general nominatim search restricted to sikkim bbox
        const res = await geocode(q);
        if(res && res.length){
          results = res.map(r=>({ id: r.place_id, lat: parseFloat(r.lat), lon: parseFloat(r.lon), tags: {display_name: r.display_name}}));
        }
      }

      // update chat bot message with summary
      const botMsgs = chatMessages.querySelectorAll('.msg.bot');
      if(botMsgs.length) botMsgs[botMsgs.length-1].textContent = `Found ${results.length} result(s). Showing on the map.`;
      if(results.length) addPOIMarkers(results, center);
      else appendChat('bot', 'No results found nearby. Try a different keyword or widen the search (e.g. "cafes near Gangtok").');
    }

    // wire chat UI
    chatSend.addEventListener('click', ()=>{ const v = chatInput.value.trim(); if(!v) return; handleQuery(v); chatInput.value=''; chatInput.focus(); });
    chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); chatSend.click(); } });
    hintRest.addEventListener('click', ()=>{ chatInput.value='restaurants near me'; chatSend.click(); });
    hintCafe.addEventListener('click', ()=>{ chatInput.value='cafes in Gangtok'; chatSend.click(); });

    // initial welcome
    appendChat('bot', 'Hi — I can search places (restaurants, ATMs, hotels, pharmacies) and show them on the map. Try: "restaurants near me" or "cafes in Gangtok"');

  </script>
</body>
</html>
